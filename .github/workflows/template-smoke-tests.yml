name: Template Smoke Tests

on:
  push:
    branches: [ master, main ]
  pull_request:

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        template: [saas-level-1, api-service, mobile-app, about-me-page]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: templates/${{ matrix.template }}/package-lock.json

      - name: Cache template node_modules
        uses: actions/cache@v4
        with:
          path: templates/${{ matrix.template }}/node_modules
          key: ${{ runner.os }}-node-${{ matrix.template }}-${{ hashFiles('templates/${{ matrix.template }}/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ matrix.template }}-

      - name: Lockfile integrity (mobile only)
        if: matrix.template == 'mobile-app'
        working-directory: templates/${{ matrix.template }}
        run: npm ci --no-audit --no-fund --ignore-scripts --dry-run

      - name: Secret scan
        working-directory: templates/${{ matrix.template }}
        run: |
          echo "üîê Running secret scan for ${{ matrix.template }}..."
          if [ -f package.json ]; then
            if npm run -s security:secrets >/dev/null 2>&1; then
              npm run security:secrets
            else
              echo "‚è≠Ô∏è  No security:secrets script defined, skipping."
            fi
          else
            echo "‚è≠Ô∏è  No package.json found, skipping secret scan."
          fi

      - name: Quick Security Check
        working-directory: templates/${{ matrix.template }}
        run: |
          echo "üîç Running quick security audit for ${{ matrix.template }}..."
          if [ -f package.json ]; then
            npm audit --audit-level=high --production || echo "‚ö†Ô∏è High/critical vulnerabilities found - check dependency-audit workflow for details"
          else
            echo "‚è≠Ô∏è  No package.json found, skipping npm audit."
          fi

      - name: Run smoke test
        env:
          CI: true
        run: |
          bash scripts/template-smoke-test.sh "${{ matrix.template }}"

      - name: Production validation (NextAuth guards)
        if: matrix.template == 'saas-level-1'
        run: bash scripts/test-production-validation.sh

      - name: Check for Critical Outdated Dependencies
        working-directory: templates/${{ matrix.template }}
        run: |
          echo "üîç Quick check for majorly outdated dependencies..."

          # Install npm-check-updates for quick check
          npm install -g npm-check-updates

          # Check for major version updates only
          outdated=$(ncu --target major --filter "next,react,typescript,expo,express" --format json || echo '{}')

          if [[ "$outdated" != "{}" ]]; then
            echo "‚ÑπÔ∏è Major updates available for critical dependencies in ${{ matrix.template }}"
            echo "Run 'npm run dependency-audit' workflow for detailed analysis"
          else
            echo "‚úÖ Critical dependencies are reasonably current"
          fi

  coverage:
    needs: smoke-test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        template: [saas-level-1, api-service, mobile-app]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: templates/${{ matrix.template }}/package-lock.json
      - name: Install deps
        working-directory: templates/${{ matrix.template }}
        run: npm ci --no-audit --no-fund
      - name: Run coverage
        working-directory: templates/${{ matrix.template }}
        env:
          CI: true
          PRISMA_GENERATE_SKIP: 1
          DATABASE_URL: "file:./dev.db"
          JWT_SECRET: "ci-coverage-secret-32-chars-minimum"
        run: |
          if [ "${{ matrix.template }}" = "saas-level-1" ]; then
            npm run test -- --coverage
          elif [ "${{ matrix.template }}" = "mobile-app" ]; then
            npm run test:coverage
          else
            npm test
          fi
      - name: Check coverage thresholds
        if: matrix.template == 'saas-level-1' || matrix.template == 'api-service' || matrix.template == 'mobile-app'
        working-directory: templates/${{ matrix.template }}
        run: |
          echo "üìä Checking coverage thresholds..."
          if [ -f "coverage/coverage-summary.json" ]; then
            LINES=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
            BRANCHES=$(cat coverage/coverage-summary.json | jq '.total.branches.pct')
            echo "Lines: $LINES%, Branches: $BRANCHES%"

            # Thresholds: 80% lines, 75% branches (from TESTING.md)
            if (( $(echo "$LINES < 80" | bc -l) )); then
              echo "‚ùå Line coverage ($LINES%) below threshold (80%)"
              exit 1
            fi
            if (( $(echo "$BRANCHES < 75" | bc -l) )); then
              echo "‚ùå Branch coverage ($BRANCHES%) below threshold (75%)"
              exit 1
            fi
            echo "‚úÖ Coverage thresholds met"
          else
            echo "‚ö†Ô∏è No coverage report found, skipping threshold check"
          fi
      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.template }}
          path: templates/${{ matrix.template }}/coverage/**

  accessibility-and-perf:
    needs: coverage
    runs-on: ubuntu-latest
      strategy:
        fail-fast: false
        matrix:
          include:
            - template: saas-level-1
              command: "npm run test:accessibility"
            - template: api-service
              command: "npm run perf:smoke"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: templates/${{ matrix.template }}/package-lock.json
      - name: Install deps
        working-directory: templates/${{ matrix.template }}
        run: npm ci --no-audit --no-fund
      - name: Run extended check
        working-directory: templates/${{ matrix.template }}
        env:
          CI: true
          PRISMA_GENERATE_SKIP: 1
          DATABASE_URL: "file:./dev.db"
          JWT_SECRET: "ci-extended-secret-32-chars-minimum"
          NEXTAUTH_SECRET: "ci-axe-secret-32-chars-minimum"
          NEXTAUTH_URL: "http://localhost:3100"
        run: ${{ matrix.command }}
