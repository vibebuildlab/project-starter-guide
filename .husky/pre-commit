# ENHANCED PRE-COMMIT HOOK - RUNS TEMPLATE TESTS BEFORE COMMIT
echo "üõ°Ô∏è  Running enhanced pre-commit checks..."

# Get files being committed
STAGED_FILES=$(git diff --cached --name-only)

# Prefer GNU timeout if available; fall back to running without a timeout
TIMEOUT_CMD=$(command -v timeout || command -v gtimeout || true)

run_with_timeout() {
  if [ -n "$TIMEOUT_CMD" ]; then
    "$TIMEOUT_CMD" 300 "$@"
  else
    "$@"
  fi
}

# Check 1: Template changes require smoke tests
TEMPLATE_CHANGES=false
if echo "$STAGED_FILES" | grep -q "templates/"; then
  echo "üîç Template files changed - running smoke tests..."
  TEMPLATE_CHANGES=true

  # Run smoke tests for all templates to ensure nothing is broken
  echo "üß™ Running mobile-app smoke test..."
  if ! run_with_timeout bash scripts/template-smoke-test.sh mobile-app > /dev/null 2>&1; then
    echo "‚ùå Mobile app smoke test failed!"
    echo "   Run: bash scripts/template-smoke-test.sh mobile-app"
    exit 1
  fi

  echo "üß™ Running saas-level-1 smoke test..."
  if ! run_with_timeout bash scripts/template-smoke-test.sh saas-level-1 > /dev/null 2>&1; then
    echo "‚ùå SaaS level-1 smoke test failed!"
    echo "   Run: bash scripts/template-smoke-test.sh saas-level-1"
    exit 1
  fi

  echo "üß™ Running api-service smoke test..."
  if ! run_with_timeout bash scripts/template-smoke-test.sh api-service > /dev/null 2>&1; then
    echo "‚ùå API service smoke test failed!"
    echo "   Run: bash scripts/template-smoke-test.sh api-service"
    exit 1
  fi

  echo "‚úÖ All template smoke tests passed!"
fi

# Check 2: CLAUDE.md maintenance
NEEDS_REVIEW=false

# Check if workflow files changed
if echo "$STAGED_FILES" | grep -q "\.github/workflows/\|scripts/\|\.claude/commands/"; then
  echo "‚ö†Ô∏è  Workflow files changed - CLAUDE.md may need update"
  NEEDS_REVIEW=true
fi

# Check if CLAUDE.md hasn't been updated in 30 days
LAST_UPDATED=$(grep "Last Updated" CLAUDE.md | grep -oE "[0-9]{4}-[0-9]{2}-[0-9]{2}" || echo "2000-01-01")
DAYS_OLD=$(( ($(date +%s) - $(date -j -f "%Y-%m-%d" "$LAST_UPDATED" +%s 2>/dev/null || echo 0)) / 86400 ))

if [ $DAYS_OLD -gt 30 ]; then
  echo "‚ö†Ô∏è  CLAUDE.md not updated in $DAYS_OLD days - consider reviewing"
  NEEDS_REVIEW=true
fi

# Check if major template changes
if echo "$STAGED_FILES" | grep -q "templates/.*/package.json\|templates/.*/.*auth\|templates/.*/.*config"; then
  echo "‚ö†Ô∏è  Template configuration changed - CLAUDE.md may need update"
  NEEDS_REVIEW=true
fi

if [ "$NEEDS_REVIEW" = true ]; then
  echo ""
  echo "üìù Reminder: CLAUDE.md may need updating"
  echo "   Review checklist:"
  echo "   - New workflow patterns documented?"
  echo "   - Testing requirements updated?"
  echo "   - Last Updated timestamp current?"
  echo ""
  echo "   Run '/review-claude-md' after commit to update"
fi

echo "‚úÖ Enhanced pre-commit checks complete"
exit 0
